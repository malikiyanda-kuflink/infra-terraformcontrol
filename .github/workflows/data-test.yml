name: data-test

on:
  pull_request:
    branches: [ test-git ]
    paths:
      - environments/test-git/data/**
      - modules/dms-mysql-to-redshift/**
      - modules/rds/**
      - modules/rds-restored/**
      - modules/redshift/**
      - modules/redshift-restored/**
  workflow_call:   
    inputs:
      triggered_by_dependency:
        type: boolean
        default: false  
  workflow_dispatch:
    inputs:
      auto_apply:
        description: "Auto-apply when a layer has changes?"
        type: boolean
        default: true
        required: false

concurrency:
  group: terraform-test-git-data-${{ github.ref }}
  cancel-in-progress: false

env:
  AWS_REGION: eu-west-2
  TF_IN_AUTOMATION: "true"
  TF_STATE_BUCKET: kuflink-test-states
  TF_LOCK_TABLE: kuflink-tf-locks-test
  ROLE_ARN: arn:aws:iam::137167813802:role/kuflink-test-github-oidc-terraform
  TERRAFORM_PATH: "C:\\terraform\\terraform.exe"

jobs:
  data:
    name: data
    runs-on: [self-hosted, tf-runner]
    permissions: { id-token: write, contents: read }
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
    env:
      LAYER: data
      TF_WORKDIR: environments/test-git/data
      TF_STATE_KEY: test-git/data/terraform.tfstate
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        working-directory: ${{ env.TF_WORKDIR }}
        shell: powershell
        run: |
          & "$env:TERRAFORM_PATH" init `
            -backend-config="bucket=$env:TF_STATE_BUCKET" `
            -backend-config="key=$env:TF_STATE_KEY" `
            -backend-config="region=$env:AWS_REGION" `
            -backend-config="dynamodb_table=$env:TF_LOCK_TABLE" `
            -backend-config="encrypt=true"

      - name: Terraform Plan
        id: plan
        working-directory: ${{ env.TF_WORKDIR }}
        shell: powershell
        run: |
          $exitCode = 0
          try {
            $planArgs = @('plan', '-no-color', '-input=false', '-out=tfplan.bin', '-detailed-exitcode')
            & "$env:TERRAFORM_PATH" @planArgs
            $exitCode = $LASTEXITCODE
          } catch {
            Write-Host "Exception during terraform plan: $($_.Exception.Message)" -ForegroundColor Red
            $exitCode = 1
          }

          Write-Host "Terraform plan exit code: $exitCode" -ForegroundColor Yellow

          if ($exitCode -eq 2) {
            Write-Host "Plan has changes" -ForegroundColor Green
            "has_changes=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          } elseif ($exitCode -eq 0) {
            Write-Host "Plan has no changes" -ForegroundColor Green
            "has_changes=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 0
          } else {
            Write-Host "Plan failed with exit code $exitCode" -ForegroundColor Red
            "has_changes=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
            exit 1
          }

      - name: Generate Plan Summary
        if: always()
        working-directory: ${{ env.TF_WORKDIR }}
        shell: powershell
        run: |
          $summary = @()

          if (Test-Path "tfplan.bin") {
            & "$env:TERRAFORM_PATH" show -no-color tfplan.bin > tfplan.txt
            & "$env:TERRAFORM_PATH" show -json tfplan.bin > tfplan.json

            $summary += "## Terraform Plan - $env:LAYER"
            $summary += ""

            if ("${{ steps.plan.outputs.has_changes }}" -eq "true") {
              $summary += "**Status:** Plan successful - has changes"
            } else {
              $summary += "**Status:** Plan successful - no changes needed"
            }

            if (Test-Path "tfplan.json") {
              $plan = Get-Content "tfplan.json" -Raw | ConvertFrom-Json
              if ($plan.resource_changes) {
                $adds    = ($plan.resource_changes | Where-Object { $_.change.actions -contains "create" }).Count
                $changes = ($plan.resource_changes | Where-Object { $_.change.actions -contains "update" }).Count
                $deletes = ($plan.resource_changes | Where-Object { $_.change.actions -contains "delete" }).Count
                
                $summary += ""
                $summary += "### Resource Changes Summary"
                $summary += "- **Add:** " + [string]$adds
                $summary += "- **Change:** " + [string]$changes
                $summary += "- **Delete:** " + [string]$deletes
                $summary += ""
                
                # Make resource details collapsible
                $summary += "<details>"
                $summary += "<summary><strong>Changed Resources</strong> (click to expand)</summary>"
                $summary += ""
                
                $hasChanges = $false
                
                foreach ($resource in $plan.resource_changes) {
                  if ($resource.change.actions -contains "create") {
                    $hasChanges = $true
                    $summary += "- :heavy_plus_sign: **CREATE:** ``$($resource.address)``"
                  }
                  elseif ($resource.change.actions -contains "update") {
                    $hasChanges = $true
                    $summary += "- :arrows_counterclockwise: **UPDATE:** ``$($resource.address)``"
                    
                    # Dynamically detect ALL changed attributes
                    if ($resource.change.before -and $resource.change.after) {
                      $before = $resource.change.before
                      $after = $resource.change.after
                      
                      # Get all property names from both objects
                      $allProps = @()
                      $allProps += $before.PSObject.Properties.Name
                      $allProps += $after.PSObject.Properties.Name
                      $allProps = $allProps | Select-Object -Unique
                      
                      # Compare each property
                      foreach ($prop in $allProps) {
                        $beforeVal = $before.$prop
                        $afterVal = $after.$prop
                        
                        # Skip null-to-null, IDs, and complex objects
                        if ($null -eq $beforeVal -and $null -eq $afterVal) { continue }
                        if ($prop -eq "id") { continue }
                        if ($beforeVal -is [System.Collections.IEnumerable] -and $beforeVal -isnot [string]) { continue }
                        if ($afterVal -is [System.Collections.IEnumerable] -and $afterVal -isnot [string]) { continue }
                        if ($beforeVal -is [PSCustomObject] -or $afterVal -is [PSCustomObject]) { continue }
                        
                        # Check if value actually changed
                        if ($beforeVal -ne $afterVal) {
                          $beforeStr = if ($null -eq $beforeVal) { "(not set)" } else { $beforeVal }
                          $afterStr = if ($null -eq $afterVal) { "(will be unset)" } else { $afterVal }
                          $summary += "  - $($prop): ``$beforeStr`` â†’ ``$afterStr``"
                        }
                      }
                    }
                  }
                  elseif ($resource.change.actions -contains "delete") {
                    $hasChanges = $true
                    $summary += "- :heavy_minus_sign: **DELETE:** ``$($resource.address)``"
                  }
                }
                
                if (-not $hasChanges) {
                  $summary += "_No resource changes detected_"
                }
                
                $summary += ""
                $summary += "</details>"
              }
            }
          } else {
            $summary += "## Terraform Plan Failed"
            $summary += ""
            $summary += "Plan failed - check terraform logs in previous step"
          }

          $summaryText = $summary -join "`r`n"
          Set-Content -Path $env:GITHUB_STEP_SUMMARY -Value $summaryText -Encoding UTF8

      - name: Upload Plan Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ env.LAYER }}-${{ github.sha }}
          path: |
            ${{ env.TF_WORKDIR }}/tfplan.bin
            ${{ env.TF_WORKDIR }}/tfplan.txt
            ${{ env.TF_WORKDIR }}/tfplan.json
          if-no-files-found: warn
          retention-days: 7

      - name: Terraform Apply
        if: steps.plan.outputs.has_changes == 'true' &&
            github.event_name == 'push' &&
            github.ref == 'refs/heads/test-git'
        working-directory: ${{ env.TF_WORKDIR }}
        shell: powershell
        run: |
          & "$env:TERRAFORM_PATH" apply -input=false -auto-approve tfplan.bin