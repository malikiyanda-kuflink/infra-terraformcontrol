name: full-stack-build

on:
  workflow_dispatch:
    inputs:
      start_from_layer:
        description: 'Start deployment from which layer?'
        required: true
        type: choice
        default: 'foundation'
        options:
          - foundation
          - platform
          - data
          - apps
      auto_apply:
        description: 'Auto-apply changes (or just plan)?'
        type: boolean
        default: true
        required: false
      reason:
        description: 'Reason for full stack build'
        required: true
        type: string

concurrency:
  group: full-stack-build-test-git
  cancel-in-progress: false

jobs:
  validate-and-log:
    runs-on: ubuntu-latest
    steps:
      - name: Log Build Information
        run: |
          echo "## 🚀 Full Stack Build Started" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Start from layer:** ${{ inputs.start_from_layer }}" >> $GITHUB_STEP_SUMMARY
          echo "**Auto-apply:** ${{ inputs.auto_apply }}" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ inputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dependency Chain:** Foundation → Platform → Data → Apps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

  foundation:
    if: inputs.start_from_layer == 'foundation'
    needs: validate-and-log
    uses: ./.github/workflows/foundation-test.yml
    with:
      triggered_by_dependency: false
    secrets: inherit

  platform:
    if: |
      inputs.start_from_layer == 'platform' ||
      inputs.start_from_layer == 'foundation'
    needs: [validate-and-log, foundation]
    uses: ./.github/workflows/platform-test.yml
    with:
      triggered_by_dependency: ${{ inputs.start_from_layer == 'foundation' }}
    secrets: inherit

  data:
    if: |
      inputs.start_from_layer == 'data' ||
      inputs.start_from_layer == 'platform' ||
      inputs.start_from_layer == 'foundation'
    needs: [validate-and-log, platform]
    uses: ./.github/workflows/data-test.yml
    with:
      triggered_by_dependency: ${{ inputs.start_from_layer != 'data' }}
    secrets: inherit

  apps:
    needs: [validate-and-log, data]
    uses: ./.github/workflows/apps-test.yml
    with:
      triggered_by_dependency: ${{ inputs.start_from_layer != 'apps' }}
    secrets: inherit

  build-complete:
    if: always()
    needs: [foundation, platform, data, apps]
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "## 📊 Full Stack Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Execution Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Foundation
          if [ "${{ needs.foundation.result }}" != "skipped" ]; then
            if [ "${{ needs.foundation.result }}" == "success" ]; then
              echo "✅ **Foundation:** Completed successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ **Foundation:** ${{ needs.foundation.result }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⏭️ **Foundation:** Skipped (started from ${{ inputs.start_from_layer }})" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Platform
          if [ "${{ needs.platform.result }}" != "skipped" ]; then
            if [ "${{ needs.platform.result }}" == "success" ]; then
              echo "✅ **Platform:** Completed successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ **Platform:** ${{ needs.platform.result }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⏭️ **Platform:** Skipped (started from ${{ inputs.start_from_layer }})" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Data
          if [ "${{ needs.data.result }}" != "skipped" ]; then
            if [ "${{ needs.data.result }}" == "success" ]; then
              echo "✅ **Data:** Completed successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ **Data:** ${{ needs.data.result }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⏭️ **Data:** Skipped (started from ${{ inputs.start_from_layer }})" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Apps
          if [ "${{ needs.apps.result }}" == "success" ]; then
            echo "✅ **Apps:** Completed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Apps:** ${{ needs.apps.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [ "${{ needs.foundation.result }}" == "failure" ] || \
             [ "${{ needs.platform.result }}" == "failure" ] || \
             [ "${{ needs.data.result }}" == "failure" ] || \
             [ "${{ needs.apps.result }}" == "failure" ]; then
            echo "## ❌ Build Failed" >> $GITHUB_STEP_SUMMARY
            echo "One or more layers failed. Check the logs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "## ✅ Build Successful" >> $GITHUB_STEP_SUMMARY
            echo "All layers completed successfully!" >> $GITHUB_STEP_SUMMARY
          fi