name: auto-destroy

on:
  workflow_dispatch:
    inputs:
      layers:
        description: 'Layers to destroy (comma-separated: apps,data,platform,foundation or "all")'
        required: true
        default: 'all'
        type: string
      confirmation:
        description: 'Type "DESTROY" to confirm'
        required: true
        type: string

permissions:  
  id-token: write
  contents: read

env:
  AWS_REGION: eu-west-2
  TF_IN_AUTOMATION: "true"
  TF_STATE_BUCKET: kuflink-test-states
  TF_LOCK_TABLE: kuflink-tf-locks-test
  ROLE_ARN: arn:aws:iam::137167813802:role/kuflink-test-github-oidc-terraform
  TERRAFORM_PATH: "C:\\terraform\\terraform.exe"

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    outputs:
      destroy_apps: ${{ steps.parse.outputs.destroy_apps }}
      destroy_data: ${{ steps.parse.outputs.destroy_data }}
      destroy_platform: ${{ steps.parse.outputs.destroy_platform }}
      destroy_foundation: ${{ steps.parse.outputs.destroy_foundation }}
    steps:
      - name: Validate Confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "DESTROY" ]; then
            echo "âŒ Invalid confirmation. You must type exactly 'DESTROY' to proceed."
            exit 1
          fi
          echo "âœ… Confirmation validated"
      
      - name: Parse Layers Input
        id: parse
        run: |
          LAYERS="${{ github.event.inputs.layers }}"
          
          echo "## ðŸ—‘ï¸ Destruction Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** test-git" >> $GITHUB_STEP_SUMMARY
          echo "**AWS Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Requested by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Layers to Destroy (in order):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine what to destroy
          if [ "$LAYERS" == "all" ]; then
            echo "destroy_apps=true" >> $GITHUB_OUTPUT
            echo "destroy_data=true" >> $GITHUB_OUTPUT
            echo "destroy_platform=true" >> $GITHUB_OUTPUT
            echo "destroy_foundation=true" >> $GITHUB_OUTPUT
            
            echo "1. ðŸ—‘ï¸ **Apps** (applications and services)" >> $GITHUB_STEP_SUMMARY
            echo "2. ðŸ—‘ï¸ **Data** (databases and data services)" >> $GITHUB_STEP_SUMMARY
            echo "3. ðŸ—‘ï¸ **Platform** (platform services)" >> $GITHUB_STEP_SUMMARY
            echo "4. ðŸ—‘ï¸ **Foundation** (networking and IAM)" >> $GITHUB_STEP_SUMMARY
          else
            # Parse comma-separated list
            if echo "$LAYERS" | grep -q "apps"; then
              echo "destroy_apps=true" >> $GITHUB_OUTPUT
              echo "1. ðŸ—‘ï¸ **Apps** (applications and services)" >> $GITHUB_STEP_SUMMARY
            else
              echo "destroy_apps=false" >> $GITHUB_OUTPUT
            fi
            
            if echo "$LAYERS" | grep -q "data"; then
              echo "destroy_data=true" >> $GITHUB_OUTPUT
              echo "2. ðŸ—‘ï¸ **Data** (databases and data services)" >> $GITHUB_STEP_SUMMARY
            else
              echo "destroy_data=false" >> $GITHUB_OUTPUT
            fi
            
            if echo "$LAYERS" | grep -q "platform"; then
              echo "destroy_platform=true" >> $GITHUB_OUTPUT
              echo "3. ðŸ—‘ï¸ **Platform** (platform services)" >> $GITHUB_STEP_SUMMARY
            else
              echo "destroy_platform=false" >> $GITHUB_OUTPUT
            fi
            
            if echo "$LAYERS" | grep -q "foundation"; then
              echo "destroy_foundation=true" >> $GITHUB_OUTPUT
              echo "4. ðŸ—‘ï¸ **Foundation** (networking and IAM)" >> $GITHUB_STEP_SUMMARY
            else
              echo "destroy_foundation=false" >> $GITHUB_OUTPUT
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ **WARNING:** This action is irreversible!" >> $GITHUB_STEP_SUMMARY

  # Destroy in reverse order: Apps â†’ Data â†’ Platform â†’ Foundation
  
  destroy-apps:
    if: needs.validate-inputs.outputs.destroy_apps == 'true'
    needs: validate-inputs
    runs-on: [self-hosted, tf-runner]
    permissions:
      id-token: write
      contents: read
    env:
      LAYER: apps
      TF_WORKDIR: environments/test-git/apps
      TF_STATE_KEY: test-git/apps/terraform.tfstate
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          role-session-name: GitHubActions-destroy-apps
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Terraform Init
        working-directory: ${{ env.TF_WORKDIR }}
        shell: powershell
        run: |
          & "$env:TERRAFORM_PATH" init `
            -backend-config="bucket=$env:TF_STATE_BUCKET" `
            -backend-config="key=$env:TF_STATE_KEY" `
            -backend-config="region=$env:AWS_REGION" `
            -backend-config="dynamodb_table=$env:TF_LOCK_TABLE" `
            -backend-config="encrypt=true"
      
      - name: Terraform Destroy
        working-directory: ${{ env.TF_WORKDIR }}
        shell: powershell
        run: |
          & "$env:TERRAFORM_PATH" destroy -auto-approve
          Write-Host "âœ… Apps layer destroyed" -ForegroundColor Green
          "## âœ… Apps Layer Destroyed" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
  
  destroy-data:
    if: |
      always() &&
      !cancelled() &&
      needs.validate-inputs.outputs.destroy_data == 'true' &&
      (needs.destroy-apps.result == 'success' || needs.destroy-apps.result == 'skipped')
    needs: [validate-inputs, destroy-apps]
    runs-on: [self-hosted, tf-runner]
    permissions:
      id-token: write
      contents: read
    env:
      LAYER: data
      TF_WORKDIR: environments/test-git/data
      TF_STATE_KEY: test-git/data/terraform.tfstate
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          role-session-name: GitHubActions-destroy-data
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Terraform Init
        working-directory: ${{ env.TF_WORKDIR }}
        shell: powershell
        run: |
          & "$env:TERRAFORM_PATH" init `
            -backend-config="bucket=$env:TF_STATE_BUCKET" `
            -backend-config="key=$env:TF_STATE_KEY" `
            -backend-config="region=$env:AWS_REGION" `
            -backend-config="dynamodb_table=$env:TF_LOCK_TABLE" `
            -backend-config="encrypt=true"
      
      - name: Terraform Destroy
        working-directory: ${{ env.TF_WORKDIR }}
        shell: powershell
        run: |
          & "$env:TERRAFORM_PATH" destroy -auto-approve
          Write-Host "âœ… Data layer destroyed" -ForegroundColor Green
          "## âœ… Data Layer Destroyed" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
  
  destroy-platform:
    if: |
      always() &&
      !cancelled() &&
      needs.validate-inputs.outputs.destroy_platform == 'true' &&
      (needs.destroy-data.result == 'success' || needs.destroy-data.result == 'skipped')
    needs: [validate-inputs, destroy-apps, destroy-data]
    runs-on: [self-hosted, tf-runner]
    permissions:
      id-token: write
      contents: read
    env:
      LAYER: platform
      TF_WORKDIR: environments/test-git/platform
      TF_STATE_KEY: test-git/platform/terraform.tfstate
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          role-session-name: GitHubActions-destroy-platform
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Terraform Init
        working-directory: ${{ env.TF_WORKDIR }}
        shell: powershell
        run: |
          & "$env:TERRAFORM_PATH" init `
            -backend-config="bucket=$env:TF_STATE_BUCKET" `
            -backend-config="key=$env:TF_STATE_KEY" `
            -backend-config="region=$env:AWS_REGION" `
            -backend-config="dynamodb_table=$env:TF_LOCK_TABLE" `
            -backend-config="encrypt=true"
      
      - name: Terraform Destroy
        working-directory: ${{ env.TF_WORKDIR }}
        shell: powershell
        run: |
          & "$env:TERRAFORM_PATH" destroy -auto-approve
          Write-Host "âœ… Platform layer destroyed" -ForegroundColor Green
          "## âœ… Platform Layer Destroyed" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
  
  destroy-foundation:
    if: |
      always() &&
      !cancelled() &&
      needs.validate-inputs.outputs.destroy_foundation == 'true' &&
      (needs.destroy-platform.result == 'success' || needs.destroy-platform.result == 'skipped')
    needs: [validate-inputs, destroy-apps, destroy-data, destroy-platform]
    runs-on: [self-hosted, tf-runner]
    permissions:
      id-token: write
      contents: read
    env:
      LAYER: foundation
      TF_WORKDIR: environments/test-git/foundation
      TF_STATE_KEY: test-git/foundation/terraform.tfstate
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.ROLE_ARN }}
          role-session-name: GitHubActions-destroy-foundation
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Terraform Init
        working-directory: ${{ env.TF_WORKDIR }}
        shell: powershell
        run: |
          & "$env:TERRAFORM_PATH" init `
            -backend-config="bucket=$env:TF_STATE_BUCKET" `
            -backend-config="key=$env:TF_STATE_KEY" `
            -backend-config="region=$env:AWS_REGION" `
            -backend-config="dynamodb_table=$env:TF_LOCK_TABLE" `
            -backend-config="encrypt=true"
      
      - name: Terraform Destroy
        working-directory: ${{ env.TF_WORKDIR }}
        shell: powershell
        run: |
          & "$env:TERRAFORM_PATH" destroy -auto-approve
          Write-Host "âœ… Foundation layer destroyed" -ForegroundColor Green
          "## âœ… Foundation Layer Destroyed" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append
  
  destruction-complete:
    if: always()
    needs: [validate-inputs, destroy-apps, destroy-data, destroy-platform, destroy-foundation]
    runs-on: ubuntu-latest
    steps:
      - name: Generate Destruction Summary
        run: |
          echo "## ðŸ—‘ï¸ Destruction Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Execution Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Apps
          if [ "${{ needs.validate-inputs.outputs.destroy_apps }}" == "true" ]; then
            if [ "${{ needs.destroy-apps.result }}" == "success" ]; then
              echo "âœ… **Apps:** Destroyed successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Apps:** Failed - ${{ needs.destroy-apps.result }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸ **Apps:** Skipped (not selected)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Data
          if [ "${{ needs.validate-inputs.outputs.destroy_data }}" == "true" ]; then
            if [ "${{ needs.destroy-data.result }}" == "success" ]; then
              echo "âœ… **Data:** Destroyed successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Data:** Failed - ${{ needs.destroy-data.result }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸ **Data:** Skipped (not selected)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Platform
          if [ "${{ needs.validate-inputs.outputs.destroy_platform }}" == "true" ]; then
            if [ "${{ needs.destroy-platform.result }}" == "success" ]; then
              echo "âœ… **Platform:** Destroyed successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Platform:** Failed - ${{ needs.destroy-platform.result }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸ **Platform:** Skipped (not selected)" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Foundation
          if [ "${{ needs.validate-inputs.outputs.destroy_foundation }}" == "true" ]; then
            if [ "${{ needs.destroy-foundation.result }}" == "success" ]; then
              echo "âœ… **Foundation:** Destroyed successfully" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Foundation:** Failed - ${{ needs.destroy-foundation.result }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "â­ï¸ **Foundation:** Skipped (not selected)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [ "${{ needs.destroy-apps.result }}" == "failure" ] || \
             [ "${{ needs.destroy-data.result }}" == "failure" ] || \
             [ "${{ needs.destroy-platform.result }}" == "failure" ] || \
             [ "${{ needs.destroy-foundation.result }}" == "failure" ]; then
            echo "## âŒ Destruction Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some layers failed to destroy. Manual intervention may be required." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "## âœ… Destruction Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All selected infrastructure has been destroyed." >> $GITHUB_STEP_SUMMARY
          fi