name: tf-destroy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        type: choice
        options:
          - test
          - staging
          # - production  # Uncomment only if you really need this
      layers:
        description: 'Layers to destroy (comma-separated: foundation,platform,data,apps or "all")'
        required: true
        default: 'all'
      confirm_destroy:
        description: 'Type "DESTROY" to confirm (case-sensitive)'
        required: true
      auto_approve:
        description: 'Skip destroy plan approval (NOT recommended for staging/production)'
        type: boolean
        default: false
      force_continue_on_failure:
        description: 'âš ï¸ Continue destroying next layers even if previous fails (DANGEROUS!)'
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

concurrency:
  group: terraform-destroy-${{ github.event.inputs.environment }}
  cancel-in-progress: false

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"

jobs:
  validate-destroy:
    runs-on: ubuntu-latest
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}
      state_bucket: ${{ steps.check.outputs.state_bucket }}
      lock_table: ${{ steps.check.outputs.lock_table }}
      layers_to_destroy: ${{ steps.check.outputs.layers_to_destroy }}
    steps:
      - name: Validate Confirmation
        id: check
        run: |
          # Validate confirmation text
          if [[ "${{ github.event.inputs.confirm_destroy }}" != "DESTROY" ]]; then
            echo "âŒ Confirmation text must be exactly 'DESTROY'"
            exit 1
          fi
          
          # Set environment-specific values
          ENV="${{ github.event.inputs.environment }}"
          case "$ENV" in
            test)
              STATE_BUCKET="kuflink-test-states"
              LOCK_TABLE="kuflink-tf-locks-test"
              ;;
            staging)
              STATE_BUCKET="kuflink-staging-states"
              LOCK_TABLE="kuflink-tf-locks-staging"
              ;;
            production)
              STATE_BUCKET="kuflink-prod-states"
              LOCK_TABLE="kuflink-tf-locks-prod"
              ;;
          esac
          
          echo "state_bucket=$STATE_BUCKET" >> $GITHUB_OUTPUT
          echo "lock_table=$LOCK_TABLE" >> $GITHUB_OUTPUT
          
          # Parse and validate layers
          LAYERS_INPUT="${{ github.event.inputs.layers }}"
          
          # Validate layer dependencies and order
          if [[ "$LAYERS_INPUT" != "all" ]]; then
            # Check for invalid combinations
            if [[ "$LAYERS_INPUT" =~ foundation.*platform ]] || \
               [[ "$LAYERS_INPUT" =~ foundation.*data ]] || \
               [[ "$LAYERS_INPUT" =~ foundation.*apps ]] || \
               [[ "$LAYERS_INPUT" =~ platform.*data ]] || \
               [[ "$LAYERS_INPUT" =~ platform.*apps ]] || \
               [[ "$LAYERS_INPUT" =~ data.*apps ]]; then
              echo "::error::âŒ Invalid layer order detected!"
              echo "::error::Layers must be destroyed in reverse dependency order:"
              echo "::error::  apps â†’ data â†’ platform â†’ foundation"
              echo "::error::"
              echo "::error::You specified: $LAYERS_INPUT"
              echo "::error::This violates the dependency order."
              exit 1
            fi
          fi
          
          # Parse layers and reverse for destroy
          if [[ "$LAYERS_INPUT" == "all" ]]; then
            # Reverse order for destroy: apps -> data -> platform -> foundation
            LAYERS_JSON='["apps","data","platform","foundation"]'
          else
            # Parse comma-separated and reverse
            IFS=',' read -ra LAYER_ARRAY <<< "$LAYERS_INPUT"
            # Remove whitespace
            for i in "${!LAYER_ARRAY[@]}"; do
              LAYER_ARRAY[$i]=$(echo "${LAYER_ARRAY[$i]}" | xargs)
            done
            # Reverse the array
            REVERSED=()
            for ((i=${#LAYER_ARRAY[@]}-1; i>=0; i--)); do
              REVERSED+=("${LAYER_ARRAY[i]}")
            done
            LAYERS_JSON=$(printf '%s\n' "${REVERSED[@]}" | jq -R . | jq -sc .)
          fi
          
          echo "layers_to_destroy=$LAYERS_JSON" >> $GITHUB_OUTPUT
          echo "can_proceed=true" >> $GITHUB_OUTPUT
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ¯ Environment: $ENV"
          echo "ðŸ—‘ï¸  Layers to destroy (in order): $LAYERS_JSON"
          if [[ "${{ github.event.inputs.force_continue_on_failure }}" == "true" ]]; then
            echo "âš ï¸  FORCE CONTINUE ENABLED - will continue even if layers fail!"
          fi
          echo "âš ï¸  THIS ACTION IS IRREVERSIBLE!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # Destroy jobs in REVERSE order: apps -> data -> platform -> foundation
  
  destroy-apps:
    needs: validate-destroy
    if: contains(fromJson(needs.validate-destroy.outputs.layers_to_destroy), 'apps')
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment }}-destroy
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment }}
      LAYER: apps
      AWS_REGION: ${{ vars.AWS_REGION }}
      TF_STATE_BUCKET: ${{ needs.validate-destroy.outputs.state_bucket }}
      TF_LOCK_TABLE: ${{ needs.validate-destroy.outputs.lock_table }}
    outputs:
      status: ${{ steps.final_status.outputs.status }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Determine AWS Role
        id: aws_role
        run: |
          case "${{ env.ENVIRONMENT }}" in
            test)
              echo "role_arn=${{ secrets.TEST_AWS_OIDC_ROLE_ARN }}" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "role_arn=${{ secrets.STAGING_AWS_OIDC_ROLE_ARN }}" >> $GITHUB_OUTPUT
              ;;
            production)
              echo "role_arn=${{ secrets.PRODUCTION_AWS_OIDC_ROLE_ARN }}" >> $GITHUB_OUTPUT
              ;;
          esac
      
      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.aws_role.outputs.role_arn }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with: { terraform_wrapper: false }
      
      - name: Terraform Init
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        run: |
          terraform init \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="key=${ENVIRONMENT}/${LAYER}/terraform.tfstate" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${TF_LOCK_TABLE}" \
            -backend-config="encrypt=true"
      
      - name: Check State for Resources
        id: state_check
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          echo "ðŸ” Checking for resources in state..."
          terraform state list > state_resources.txt 2>&1 || true
          
          if [ ! -s state_resources.txt ] || ! grep -q . state_resources.txt; then
            echo "âš ï¸ No resources found in state"
            echo "has_resources=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“¦ Found resources in state:"
            cat state_resources.txt
            echo "has_resources=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Refresh State
        if: steps.state_check.outputs.has_resources == 'true'
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          echo "ðŸ”„ Refreshing Terraform state..."
          terraform refresh -var="environment=${ENVIRONMENT}" || {
            echo "âš ï¸ State refresh had issues but continuing to plan"
          }
      
      - name: Terraform Destroy Plan
        id: plan
        if: steps.state_check.outputs.has_resources == 'true'
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          set +e
          terraform plan -destroy -no-color -out=destroy.tfplan -var="environment=${ENVIRONMENT}" 2>&1 | tee destroy_plan_output.txt
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Check if plan shows no changes
          if grep -q "No changes" destroy_plan_output.txt; then
            echo "âœ… No changes needed - state is already clean"
            echo "plan_success=true" >> $GITHUB_OUTPUT
            echo "no_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "plan_success=true" >> $GITHUB_OUTPUT
            echo "no_changes=false" >> $GITHUB_OUTPUT
          else
            echo "plan_success=false" >> $GITHUB_OUTPUT
            echo "no_changes=false" >> $GITHUB_OUTPUT
            
            # Provide helpful error context
            echo "::error::Destroy plan failed. Common causes:"
            echo "::error::  - Resources have dependencies that still exist"
            echo "::error::  - State is out of sync with actual infrastructure"
            echo "::error::  - Resources were manually deleted outside Terraform"
          fi
          
          exit $EXIT_CODE
      
      - name: Show Destroy Plan
        if: |
          steps.plan.outputs.plan_success == 'true' && 
          steps.plan.outputs.no_changes != 'true' &&
          steps.state_check.outputs.has_resources == 'true'
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        run: terraform show destroy.tfplan
      
      - name: Terraform Destroy (Attempt 1)
        id: destroy_attempt1
        if: |
          steps.plan.outputs.plan_success == 'true' &&
          steps.plan.outputs.no_changes != 'true' &&
          steps.state_check.outputs.has_resources == 'true' &&
          (github.event.inputs.auto_approve == 'true' || github.event.inputs.environment == 'test')
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          terraform apply -auto-approve destroy.tfplan 2>&1 | tee destroy_attempt1_output.txt
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
      
      - name: Wait Before Retry
        if: steps.destroy_attempt1.outcome == 'failure'
        run: |
          echo "âš ï¸ First destroy attempt failed. Waiting 30 seconds before retry..."
          sleep 30
      
      - name: Refresh State and Retry Destroy
        id: destroy_attempt2
        if: steps.destroy_attempt1.outcome == 'failure'
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          echo "ðŸ”„ Refreshing state and retrying destroy..."
          terraform refresh -var="environment=${ENVIRONMENT}" || true
          terraform destroy -auto-approve -var="environment=${ENVIRONMENT}" 2>&1 | tee destroy_attempt2_output.txt
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
      
      - name: Final Status Check
        id: final_status
        if: always()
        run: |
          # No resources in state - success
          if [[ "${{ steps.state_check.outputs.has_resources }}" != "true" ]]; then
            echo "âœ… No resources to destroy - layer already clean"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Plan showed no changes - success
          if [[ "${{ steps.plan.outputs.no_changes }}" == "true" ]]; then
            echo "âœ… No changes needed - layer already clean"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Plan failed
          if [[ "${{ steps.plan.outputs.plan_success }}" != "true" ]]; then
            echo "âŒ Destroy plan failed"
            echo "status=failed" >> $GITHUB_OUTPUT
            if [[ "${{ github.event.inputs.force_continue_on_failure }}" == "true" ]]; then
              echo "âš ï¸ Force-continue enabled, allowing workflow to proceed"
              echo "status=failed_forced" >> $GITHUB_OUTPUT
              exit 0
            fi
            exit 1
          fi
          
          # Check destroy attempts
          if [[ "${{ steps.destroy_attempt2.outcome }}" == "success" ]]; then
            echo "âœ… Apps layer destroyed successfully on retry"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          elif [[ "${{ steps.destroy_attempt1.outcome }}" == "success" ]]; then
            echo "âœ… Apps layer destroyed successfully"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          elif [[ "${{ github.event.inputs.force_continue_on_failure }}" == "true" ]]; then
            echo "âš ï¸ Apps layer destroy FAILED but force-continue is enabled"
            echo "status=failed_forced" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "âŒ Apps layer destroy failed after retries"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "::error::Apps layer destroy failed. Review logs and manually clean up if needed."
            exit 1
          fi
      
      - name: Generate Summary
        if: always()
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        shell: bash
        run: |
          echo "## Terraform Destroy Summary - ${{ env.LAYER }} (${{ env.ENVIRONMENT }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # State check results
          if [[ "${{ steps.state_check.outputs.has_resources }}" != "true" ]]; then
            echo "### âœ… No Resources Found" >> $GITHUB_STEP_SUMMARY
            echo "State file is empty or contains no resources." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.plan.outputs.no_changes }}" == "true" ]]; then
            echo "### âœ… No Changes Needed" >> $GITHUB_STEP_SUMMARY
            echo "All resources already destroyed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f state_resources.txt ] && [ -s state_resources.txt ]; then
            echo "<details><summary>Resources found in state</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat state_resources.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f destroy_plan_output.txt ]; then
            PLAN_SUMMARY=$(grep -E "Plan:|No changes\." destroy_plan_output.txt | tail -1 || echo "Destroy plan completed")
            echo "### ðŸ“‹ Destroy Plan" >> $GITHUB_STEP_SUMMARY
            echo "$PLAN_SUMMARY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>View full destroy plan output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat destroy_plan_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f destroy_attempt1_output.txt ]; then
            sed 's/\x1b\[[0-9;]*m//g' destroy_attempt1_output.txt > destroy_attempt1_clean.txt
            DESTROY_SUMMARY=$(grep -E "Destroy complete!|Apply complete!" destroy_attempt1_clean.txt | tail -1 || echo "Destroy attempt 1 completed")
            
            if [[ "${{ steps.destroy_attempt1.outcome }}" == "success" ]]; then
              echo "### âœ… Destroy (Attempt 1 - Success)" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Destroy (Attempt 1 - Failed)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "$DESTROY_SUMMARY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>View full destroy attempt 1 output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat destroy_attempt1_clean.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f destroy_attempt2_output.txt ]; then
            sed 's/\x1b\[[0-9;]*m//g' destroy_attempt2_output.txt > destroy_attempt2_clean.txt
            DESTROY_SUMMARY=$(grep -E "Destroy complete!|Apply complete!" destroy_attempt2_clean.txt | tail -1 || echo "Destroy attempt 2 completed")
            
            if [[ "${{ steps.destroy_attempt2.outcome }}" == "success" ]]; then
              echo "### âœ… Destroy (Attempt 2 - Success after retry)" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Destroy (Attempt 2 - Failed)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "$DESTROY_SUMMARY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>View full destroy attempt 2 output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat destroy_attempt2_clean.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

  destroy-data:
    needs: [validate-destroy, destroy-apps]
    if: |
      always() &&
      (needs.destroy-apps.result == 'success' || needs.destroy-apps.result == 'skipped' || github.event.inputs.force_continue_on_failure == 'true') &&
      contains(fromJson(needs.validate-destroy.outputs.layers_to_destroy), 'data')
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment }}-destroy
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment }}
      LAYER: data
      AWS_REGION: ${{ vars.AWS_REGION }}
      TF_STATE_BUCKET: ${{ needs.validate-destroy.outputs.state_bucket }}
      TF_LOCK_TABLE: ${{ needs.validate-destroy.outputs.lock_table }}
    outputs:
      status: ${{ steps.final_status.outputs.status }}
    steps:
      - name: Check Previous Layer Status
        run: |
          if [[ "${{ needs.destroy-apps.result }}" == "failure" ]]; then
            if [[ "${{ github.event.inputs.force_continue_on_failure }}" == "true" ]]; then
              echo "::warning::âš ï¸ Previous layer (apps) failed but continuing due to force flag"
            else
              echo "::error::âŒ Previous layer (apps) failed - cannot proceed safely"
              exit 1
            fi
          elif [[ "${{ needs.destroy-apps.outputs.status }}" == "failed_forced" ]]; then
            echo "::warning::âš ï¸ Previous layer (apps) was force-continued after failure"
          fi
      
      - uses: actions/checkout@v4
      
      - name: Determine AWS Role
        id: aws_role
        run: |
          case "${{ env.ENVIRONMENT }}" in
            test)
              echo "role_arn=${{ secrets.TEST_AWS_OIDC_ROLE_ARN }}" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "role_arn=${{ secrets.STAGING_AWS_OIDC_ROLE_ARN }}" >> $GITHUB_OUTPUT
              ;;
            production)
              echo "role_arn=${{ secrets.PRODUCTION_AWS_OIDC_ROLE_ARN }}" >> $GITHUB_OUTPUT
              ;;
          esac
      
      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.aws_role.outputs.role_arn }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with: { terraform_wrapper: false }
      
      - name: Terraform Init
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        run: |
          terraform init \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="key=${ENVIRONMENT}/${LAYER}/terraform.tfstate" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${TF_LOCK_TABLE}" \
            -backend-config="encrypt=true"
      
      - name: Check State for Resources
        id: state_check
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          echo "ðŸ” Checking for resources in state..."
          terraform state list > state_resources.txt 2>&1 || true
          
          if [ ! -s state_resources.txt ] || ! grep -q . state_resources.txt; then
            echo "âš ï¸ No resources found in state"
            echo "has_resources=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“¦ Found resources in state:"
            cat state_resources.txt
            echo "has_resources=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Refresh State
        if: steps.state_check.outputs.has_resources == 'true'
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          echo "ðŸ”„ Refreshing Terraform state..."
          terraform refresh -var="environment=${ENVIRONMENT}" || {
            echo "âš ï¸ State refresh had issues but continuing to plan"
          }
      
      - name: Terraform Destroy Plan
        id: plan
        if: steps.state_check.outputs.has_resources == 'true'
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          set +e
          terraform plan -destroy -no-color -out=destroy.tfplan -var="environment=${ENVIRONMENT}" 2>&1 | tee destroy_plan_output.txt
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Check if plan shows no changes
          if grep -q "No changes" destroy_plan_output.txt; then
            echo "âœ… No changes needed - state is already clean"
            echo "plan_success=true" >> $GITHUB_OUTPUT
            echo "no_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "plan_success=true" >> $GITHUB_OUTPUT
            echo "no_changes=false" >> $GITHUB_OUTPUT
          else
            echo "plan_success=false" >> $GITHUB_OUTPUT
            echo "no_changes=false" >> $GITHUB_OUTPUT
            
            echo "::error::Destroy plan failed. Common causes:"
            echo "::error::  - Resources have dependencies that still exist"
            echo "::error::  - State is out of sync with actual infrastructure"
            echo "::error::  - Resources were manually deleted outside Terraform"
          fi
          
          exit $EXIT_CODE
      
      - name: Show Destroy Plan
        if: |
          steps.plan.outputs.plan_success == 'true' && 
          steps.plan.outputs.no_changes != 'true' &&
          steps.state_check.outputs.has_resources == 'true'
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        run: terraform show destroy.tfplan
      
      - name: Terraform Destroy (Attempt 1)
        id: destroy_attempt1
        if: |
          steps.plan.outputs.plan_success == 'true' &&
          steps.plan.outputs.no_changes != 'true' &&
          steps.state_check.outputs.has_resources == 'true' &&
          (github.event.inputs.auto_approve == 'true' || github.event.inputs.environment == 'test')
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          terraform apply -auto-approve destroy.tfplan 2>&1 | tee destroy_attempt1_output.txt
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
      
      - name: Wait Before Retry
        if: steps.destroy_attempt1.outcome == 'failure'
        run: |
          echo "âš ï¸ First destroy attempt failed. Waiting 30 seconds before retry..."
          sleep 30
      
      - name: Refresh State and Retry Destroy
        id: destroy_attempt2
        if: steps.destroy_attempt1.outcome == 'failure'
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          echo "ðŸ”„ Refreshing state and retrying destroy..."
          terraform refresh -var="environment=${ENVIRONMENT}" || true
          terraform destroy -auto-approve -var="environment=${ENVIRONMENT}" 2>&1 | tee destroy_attempt2_output.txt
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
      
      - name: Final Status Check
        id: final_status
        if: always()
        run: |
          if [[ "${{ steps.state_check.outputs.has_resources }}" != "true" ]]; then
            echo "âœ… No resources to destroy - layer already clean"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [[ "${{ steps.plan.outputs.no_changes }}" == "true" ]]; then
            echo "âœ… No changes needed - layer already clean"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [[ "${{ steps.plan.outputs.plan_success }}" != "true" ]]; then
            echo "âŒ Destroy plan failed"
            echo "status=failed" >> $GITHUB_OUTPUT
            if [[ "${{ github.event.inputs.force_continue_on_failure }}" == "true" ]]; then
              echo "âš ï¸ Force-continue enabled, allowing workflow to proceed"
              echo "status=failed_forced" >> $GITHUB_OUTPUT
              exit 0
            fi
            exit 1
          fi
          
          if [[ "${{ steps.destroy_attempt2.outcome }}" == "success" ]]; then
            echo "âœ… Data layer destroyed successfully on retry"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          elif [[ "${{ steps.destroy_attempt1.outcome }}" == "success" ]]; then
            echo "âœ… Data layer destroyed successfully"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          elif [[ "${{ github.event.inputs.force_continue_on_failure }}" == "true" ]]; then
            echo "âš ï¸ Data layer destroy FAILED but force-continue is enabled"
            echo "status=failed_forced" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "âŒ Data layer destroy failed after retries"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "::error::Data layer destroy failed. Review logs and manually clean up if needed."
            exit 1
          fi
      
      - name: Generate Summary
        if: always()
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        shell: bash
        run: |
          echo "## Terraform Destroy Summary - ${{ env.LAYER }} (${{ env.ENVIRONMENT }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.state_check.outputs.has_resources }}" != "true" ]]; then
            echo "### âœ… No Resources Found" >> $GITHUB_STEP_SUMMARY
            echo "State file is empty or contains no resources." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.plan.outputs.no_changes }}" == "true" ]]; then
            echo "### âœ… No Changes Needed" >> $GITHUB_STEP_SUMMARY
            echo "All resources already destroyed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f state_resources.txt ] && [ -s state_resources.txt ]; then
            echo "<details><summary>Resources found in state</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat state_resources.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f destroy_plan_output.txt ]; then
            PLAN_SUMMARY=$(grep -E "Plan:|No changes\." destroy_plan_output.txt | tail -1 || echo "Destroy plan completed")
            echo "### ðŸ“‹ Destroy Plan" >> $GITHUB_STEP_SUMMARY
            echo "$PLAN_SUMMARY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>View full destroy plan output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat destroy_plan_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f destroy_attempt1_output.txt ]; then
            sed 's/\x1b\[[0-9;]*m//g' destroy_attempt1_output.txt > destroy_attempt1_clean.txt
            DESTROY_SUMMARY=$(grep -E "Destroy complete!|Apply complete!" destroy_attempt1_clean.txt | tail -1 || echo "Destroy attempt 1 completed")
            
            if [[ "${{ steps.destroy_attempt1.outcome }}" == "success" ]]; then
              echo "### âœ… Destroy (Attempt 1 - Success)" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Destroy (Attempt 1 - Failed)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "$DESTROY_SUMMARY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>View full destroy attempt 1 output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat destroy_attempt1_clean.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f destroy_attempt2_output.txt ]; then
            sed 's/\x1b\[[0-9;]*m//g' destroy_attempt2_output.txt > destroy_attempt2_clean.txt
            DESTROY_SUMMARY=$(grep -E "Destroy complete!|Apply complete!" destroy_attempt2_clean.txt | tail -1 || echo "Destroy attempt 2 completed")
            
            if [[ "${{ steps.destroy_attempt2.outcome }}" == "success" ]]; then
              echo "### âœ… Destroy (Attempt 2 - Success after retry)" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Destroy (Attempt 2 - Failed)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "$DESTROY_SUMMARY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>View full destroy attempt 2 output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat destroy_attempt2_clean.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

  destroy-platform:
    needs: [validate-destroy, destroy-data]
    if: |
      always() &&
      (needs.destroy-data.result == 'success' || needs.destroy-data.result == 'skipped' || github.event.inputs.force_continue_on_failure == 'true') &&
      contains(fromJson(needs.validate-destroy.outputs.layers_to_destroy), 'platform')
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment }}-destroy
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment }}
      LAYER: platform
      AWS_REGION: ${{ vars.AWS_REGION }}
      TF_STATE_BUCKET: ${{ needs.validate-destroy.outputs.state_bucket }}
      TF_LOCK_TABLE: ${{ needs.validate-destroy.outputs.lock_table }}
    outputs:
      status: ${{ steps.final_status.outputs.status }}
    steps:
      - name: Check Previous Layer Status
        run: |
          if [[ "${{ needs.destroy-data.result }}" == "failure" ]]; then
            if [[ "${{ github.event.inputs.force_continue_on_failure }}" == "true" ]]; then
              echo "::warning::âš ï¸ Previous layer (data) failed but continuing due to force flag"
            else
              echo "::error::âŒ Previous layer (data) failed - cannot proceed safely"
              exit 1
            fi
          elif [[ "${{ needs.destroy-data.outputs.status }}" == "failed_forced" ]]; then
            echo "::warning::âš ï¸ Previous layer (data) was force-continued after failure"
          fi
      
      - uses: actions/checkout@v4
      
      - name: Determine AWS Role
        id: aws_role
        run: |
          case "${{ env.ENVIRONMENT }}" in
            test)
              echo "role_arn=${{ secrets.TEST_AWS_OIDC_ROLE_ARN }}" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "role_arn=${{ secrets.STAGING_AWS_OIDC_ROLE_ARN }}" >> $GITHUB_OUTPUT
              ;;
            production)
              echo "role_arn=${{ secrets.PRODUCTION_AWS_OIDC_ROLE_ARN }}" >> $GITHUB_OUTPUT
              ;;
          esac
      
      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.aws_role.outputs.role_arn }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with: { terraform_wrapper: false }
      
      - name: Terraform Init
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        run: |
          terraform init \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="key=${ENVIRONMENT}/${LAYER}/terraform.tfstate" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${TF_LOCK_TABLE}" \
            -backend-config="encrypt=true"
      
      - name: Check State for Resources
        id: state_check
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          echo "ðŸ” Checking for resources in state..."
          terraform state list > state_resources.txt 2>&1 || true
          
          if [ ! -s state_resources.txt ] || ! grep -q . state_resources.txt; then
            echo "âš ï¸ No resources found in state"
            echo "has_resources=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“¦ Found resources in state:"
            cat state_resources.txt
            echo "has_resources=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Refresh State
        if: steps.state_check.outputs.has_resources == 'true'
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          echo "ðŸ”„ Refreshing Terraform state..."
          terraform refresh -var="environment=${ENVIRONMENT}" || {
            echo "âš ï¸ State refresh had issues but continuing to plan"
          }
      
      - name: Terraform Destroy Plan
        id: plan
        if: steps.state_check.outputs.has_resources == 'true'
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          set +e
          terraform plan -destroy -no-color -out=destroy.tfplan -var="environment=${ENVIRONMENT}" 2>&1 | tee destroy_plan_output.txt
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          if grep -q "No changes" destroy_plan_output.txt; then
            echo "âœ… No changes needed - state is already clean"
            echo "plan_success=true" >> $GITHUB_OUTPUT
            echo "no_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "plan_success=true" >> $GITHUB_OUTPUT
            echo "no_changes=false" >> $GITHUB_OUTPUT
          else
            echo "plan_success=false" >> $GITHUB_OUTPUT
            echo "no_changes=false" >> $GITHUB_OUTPUT
            
            echo "::error::Destroy plan failed. Common causes:"
            echo "::error::  - Resources have dependencies that still exist"
            echo "::error::  - State is out of sync with actual infrastructure"
            echo "::error::  - Resources were manually deleted outside Terraform"
          fi
          
          exit $EXIT_CODE
      
      - name: Show Destroy Plan
        if: |
          steps.plan.outputs.plan_success == 'true' && 
          steps.plan.outputs.no_changes != 'true' &&
          steps.state_check.outputs.has_resources == 'true'
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        run: terraform show destroy.tfplan
      
      - name: Terraform Destroy (Attempt 1)
        id: destroy_attempt1
        if: |
          steps.plan.outputs.plan_success == 'true' &&
          steps.plan.outputs.no_changes != 'true' &&
          steps.state_check.outputs.has_resources == 'true' &&
          (github.event.inputs.auto_approve == 'true' || github.event.inputs.environment == 'test')
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          terraform apply -auto-approve destroy.tfplan 2>&1 | tee destroy_attempt1_output.txt
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
      
      - name: Wait Before Retry
        if: steps.destroy_attempt1.outcome == 'failure'
        run: |
          echo "âš ï¸ First destroy attempt failed. Waiting 30 seconds before retry..."
          sleep 30
      
      - name: Refresh State and Retry Destroy
        id: destroy_attempt2
        if: steps.destroy_attempt1.outcome == 'failure'
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          echo "ðŸ”„ Refreshing state and retrying destroy..."
          terraform refresh -var="environment=${ENVIRONMENT}" || true
          terraform destroy -auto-approve -var="environment=${ENVIRONMENT}" 2>&1 | tee destroy_attempt2_output.txt
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
      
      - name: Final Status Check
        id: final_status
        if: always()
        run: |
          if [[ "${{ steps.state_check.outputs.has_resources }}" != "true" ]]; then
            echo "âœ… No resources to destroy - layer already clean"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [[ "${{ steps.plan.outputs.no_changes }}" == "true" ]]; then
            echo "âœ… No changes needed - layer already clean"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [[ "${{ steps.plan.outputs.plan_success }}" != "true" ]]; then
            echo "âŒ Destroy plan failed"
            echo "status=failed" >> $GITHUB_OUTPUT
            if [[ "${{ github.event.inputs.force_continue_on_failure }}" == "true" ]]; then
              echo "âš ï¸ Force-continue enabled, allowing workflow to proceed"
              echo "status=failed_forced" >> $GITHUB_OUTPUT
              exit 0
            fi
            exit 1
          fi
          
          if [[ "${{ steps.destroy_attempt2.outcome }}" == "success" ]]; then
            echo "âœ… Platform layer destroyed successfully on retry"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          elif [[ "${{ steps.destroy_attempt1.outcome }}" == "success" ]]; then
            echo "âœ… Platform layer destroyed successfully"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          elif [[ "${{ github.event.inputs.force_continue_on_failure }}" == "true" ]]; then
            echo "âš ï¸ Platform layer destroy FAILED but force-continue is enabled"
            echo "status=failed_forced" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "âŒ Platform layer destroy failed after retries"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "::error::Platform layer destroy failed. Review logs and manually clean up if needed."
            exit 1
          fi
      
      - name: Generate Summary
        if: always()
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        shell: bash
        run: |
          echo "## Terraform Destroy Summary - ${{ env.LAYER }} (${{ env.ENVIRONMENT }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.state_check.outputs.has_resources }}" != "true" ]]; then
            echo "### âœ… No Resources Found" >> $GITHUB_STEP_SUMMARY
            echo "State file is empty or contains no resources." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.plan.outputs.no_changes }}" == "true" ]]; then
            echo "### âœ… No Changes Needed" >> $GITHUB_STEP_SUMMARY
            echo "All resources already destroyed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f state_resources.txt ] && [ -s state_resources.txt ]; then
            echo "<details><summary>Resources found in state</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat state_resources.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f destroy_plan_output.txt ]; then
            PLAN_SUMMARY=$(grep -E "Plan:|No changes\." destroy_plan_output.txt | tail -1 || echo "Destroy plan completed")
            echo "### ðŸ“‹ Destroy Plan" >> $GITHUB_STEP_SUMMARY
            echo "$PLAN_SUMMARY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>View full destroy plan output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat destroy_plan_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f destroy_attempt1_output.txt ]; then
            sed 's/\x1b\[[0-9;]*m//g' destroy_attempt1_output.txt > destroy_attempt1_clean.txt
            DESTROY_SUMMARY=$(grep -E "Destroy complete!|Apply complete!" destroy_attempt1_clean.txt | tail -1 || echo "Destroy attempt 1 completed")
            
            if [[ "${{ steps.destroy_attempt1.outcome }}" == "success" ]]; then
              echo "### âœ… Destroy (Attempt 1 - Success)" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Destroy (Attempt 1 - Failed)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "$DESTROY_SUMMARY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>View full destroy attempt 1 output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat destroy_attempt1_clean.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f destroy_attempt2_output.txt ]; then
            sed 's/\x1b\[[0-9;]*m//g' destroy_attempt2_output.txt > destroy_attempt2_clean.txt
            DESTROY_SUMMARY=$(grep -E "Destroy complete!|Apply complete!" destroy_attempt2_clean.txt | tail -1 || echo "Destroy attempt 2 completed")
            
            if [[ "${{ steps.destroy_attempt2.outcome }}" == "success" ]]; then
              echo "### âœ… Destroy (Attempt 2 - Success after retry)" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Destroy (Attempt 2 - Failed)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "$DESTROY_SUMMARY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>View full destroy attempt 2 output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat destroy_attempt2_clean.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

  destroy-foundation:
    needs: [validate-destroy, destroy-platform]
    if: |
      always() &&
      (needs.destroy-platform.result == 'success' || needs.destroy-platform.result == 'skipped' || github.event.inputs.force_continue_on_failure == 'true') &&
      contains(fromJson(needs.validate-destroy.outputs.layers_to_destroy), 'foundation')
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.inputs.environment }}-destroy
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment }}
      LAYER: foundation
      AWS_REGION: ${{ vars.AWS_REGION }}
      TF_STATE_BUCKET: ${{ needs.validate-destroy.outputs.state_bucket }}
      TF_LOCK_TABLE: ${{ needs.validate-destroy.outputs.lock_table }}
    outputs:
      status: ${{ steps.final_status.outputs.status }}
    steps:
      - name: Check Previous Layer Status
        run: |
          if [[ "${{ needs.destroy-platform.result }}" == "failure" ]]; then
            if [[ "${{ github.event.inputs.force_continue_on_failure }}" == "true" ]]; then
              echo "::warning::âš ï¸ Previous layer (platform) failed but continuing due to force flag"
            else
              echo "::error::âŒ Previous layer (platform) failed - cannot proceed safely"
              exit 1
            fi
          elif [[ "${{ needs.destroy-platform.outputs.status }}" == "failed_forced" ]]; then
            echo "::warning::âš ï¸ Previous layer (platform) was force-continued after failure"
          fi
      
      - uses: actions/checkout@v4
      
      - name: Determine AWS Role
        id: aws_role
        run: |
          case "${{ env.ENVIRONMENT }}" in
            test)
              echo "role_arn=${{ secrets.TEST_AWS_OIDC_ROLE_ARN }}" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "role_arn=${{ secrets.STAGING_AWS_OIDC_ROLE_ARN }}" >> $GITHUB_OUTPUT
              ;;
            production)
              echo "role_arn=${{ secrets.PRODUCTION_AWS_OIDC_ROLE_ARN }}" >> $GITHUB_OUTPUT
              ;;
          esac
      
      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.aws_role.outputs.role_arn }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with: { terraform_wrapper: false }
      
      - name: Terraform Init
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        run: |
          terraform init \
            -backend-config="bucket=${TF_STATE_BUCKET}" \
            -backend-config="key=${ENVIRONMENT}/${LAYER}/terraform.tfstate" \
            -backend-config="region=${AWS_REGION}" \
            -backend-config="dynamodb_table=${TF_LOCK_TABLE}" \
            -backend-config="encrypt=true"
      
      - name: Check State for Resources
        id: state_check
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          echo "ðŸ” Checking for resources in state..."
          terraform state list > state_resources.txt 2>&1 || true
          
          if [ ! -s state_resources.txt ] || ! grep -q . state_resources.txt; then
            echo "âš ï¸ No resources found in state"
            echo "has_resources=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“¦ Found resources in state:"
            cat state_resources.txt
            echo "has_resources=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Refresh State
        if: steps.state_check.outputs.has_resources == 'true'
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          echo "ðŸ”„ Refreshing Terraform state..."
          terraform refresh -var="environment=${ENVIRONMENT}" || {
            echo "âš ï¸ State refresh had issues but continuing to plan"
          }
      
      - name: Terraform Destroy Plan
        id: plan
        if: steps.state_check.outputs.has_resources == 'true'
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          set +e
          terraform plan -destroy -no-color -out=destroy.tfplan -var="environment=${ENVIRONMENT}" 2>&1 | tee destroy_plan_output.txt
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          if grep -q "No changes" destroy_plan_output.txt; then
            echo "âœ… No changes needed - state is already clean"
            echo "plan_success=true" >> $GITHUB_OUTPUT
            echo "no_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "plan_success=true" >> $GITHUB_OUTPUT
            echo "no_changes=false" >> $GITHUB_OUTPUT
          else
            echo "plan_success=false" >> $GITHUB_OUTPUT
            echo "no_changes=false" >> $GITHUB_OUTPUT
            
            echo "::error::Destroy plan failed. Common causes:"
            echo "::error::  - Resources have dependencies that still exist"
            echo "::error::  - State is out of sync with actual infrastructure"
            echo "::error::  - Resources were manually deleted outside Terraform"
          fi
          
          exit $EXIT_CODE
      
      - name: Show Destroy Plan
        if: |
          steps.plan.outputs.plan_success == 'true' && 
          steps.plan.outputs.no_changes != 'true' &&
          steps.state_check.outputs.has_resources == 'true'
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        run: terraform show destroy.tfplan
      
      - name: Terraform Destroy (Attempt 1)
        id: destroy_attempt1
        if: |
          steps.plan.outputs.plan_success == 'true' &&
          steps.plan.outputs.no_changes != 'true' &&
          steps.state_check.outputs.has_resources == 'true' &&
          (github.event.inputs.auto_approve == 'true' || github.event.inputs.environment == 'test')
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          terraform apply -auto-approve destroy.tfplan 2>&1 | tee destroy_attempt1_output.txt
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
      
      - name: Wait Before Retry
        if: steps.destroy_attempt1.outcome == 'failure'
        run: |
          echo "âš ï¸ First destroy attempt failed. Waiting 30 seconds before retry..."
          sleep 30
      
      - name: Refresh State and Retry Destroy
        id: destroy_attempt2
        if: steps.destroy_attempt1.outcome == 'failure'
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        continue-on-error: true
        run: |
          echo "ðŸ”„ Refreshing state and retrying destroy..."
          terraform refresh -var="environment=${ENVIRONMENT}" || true
          terraform destroy -auto-approve -var="environment=${ENVIRONMENT}" 2>&1 | tee destroy_attempt2_output.txt
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit $EXIT_CODE
      
      - name: Final Status Check
        id: final_status
        if: always()
        run: |
          if [[ "${{ steps.state_check.outputs.has_resources }}" != "true" ]]; then
            echo "âœ… No resources to destroy - layer already clean"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [[ "${{ steps.plan.outputs.no_changes }}" == "true" ]]; then
            echo "âœ… No changes needed - layer already clean"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [[ "${{ steps.plan.outputs.plan_success }}" != "true" ]]; then
            echo "âŒ Destroy plan failed"
            echo "status=failed" >> $GITHUB_OUTPUT
            if [[ "${{ github.event.inputs.force_continue_on_failure }}" == "true" ]]; then
              echo "âš ï¸ Force-continue enabled, allowing workflow to proceed"
              echo "status=failed_forced" >> $GITHUB_OUTPUT
              exit 0
            fi
            exit 1
          fi
          
          if [[ "${{ steps.destroy_attempt2.outcome }}" == "success" ]]; then
            echo "âœ… Foundation layer destroyed successfully on retry"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          elif [[ "${{ steps.destroy_attempt1.outcome }}" == "success" ]]; then
            echo "âœ… Foundation layer destroyed successfully"
            echo "status=success" >> $GITHUB_OUTPUT
            exit 0
          elif [[ "${{ github.event.inputs.force_continue_on_failure }}" == "true" ]]; then
            echo "âš ï¸ Foundation layer destroy FAILED but force-continue is enabled"
            echo "status=failed_forced" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "âŒ Foundation layer destroy failed after retries"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "::error::Foundation layer destroy failed. Review logs and manually clean up if needed."
            exit 1
          fi
      
      - name: Generate Summary
        if: always()
        working-directory: environments/${{ env.ENVIRONMENT }}/${{ env.LAYER }}
        shell: bash
        run: |
          echo "## Terraform Destroy Summary - ${{ env.LAYER }} (${{ env.ENVIRONMENT }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.state_check.outputs.has_resources }}" != "true" ]]; then
            echo "### âœ… No Resources Found" >> $GITHUB_STEP_SUMMARY
            echo "State file is empty or contains no resources." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.plan.outputs.no_changes }}" == "true" ]]; then
            echo "### âœ… No Changes Needed" >> $GITHUB_STEP_SUMMARY
            echo "All resources already destroyed." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f state_resources.txt ] && [ -s state_resources.txt ]; then
            echo "<details><summary>Resources found in state</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat state_resources.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f destroy_plan_output.txt ]; then
            PLAN_SUMMARY=$(grep -E "Plan:|No changes\." destroy_plan_output.txt | tail -1 || echo "Destroy plan completed")
            echo "### ðŸ“‹ Destroy Plan" >> $GITHUB_STEP_SUMMARY
            echo "$PLAN_SUMMARY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>View full destroy plan output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat destroy_plan_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f destroy_attempt1_output.txt ]; then
            sed 's/\x1b\[[0-9;]*m//g' destroy_attempt1_output.txt > destroy_attempt1_clean.txt
            DESTROY_SUMMARY=$(grep -E "Destroy complete!|Apply complete!" destroy_attempt1_clean.txt | tail -1 || echo "Destroy attempt 1 completed")
            
            if [[ "${{ steps.destroy_attempt1.outcome }}" == "success" ]]; then
              echo "### âœ… Destroy (Attempt 1 - Success)" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Destroy (Attempt 1 - Failed)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "$DESTROY_SUMMARY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>View full destroy attempt 1 output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat destroy_attempt1_clean.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ -f destroy_attempt2_output.txt ]; then
            sed 's/\x1b\[[0-9;]*m//g' destroy_attempt2_output.txt > destroy_attempt2_clean.txt
            DESTROY_SUMMARY=$(grep -E "Destroy complete!|Apply complete!" destroy_attempt2_clean.txt | tail -1 || echo "Destroy attempt 2 completed")
            
            if [[ "${{ steps.destroy_attempt2.outcome }}" == "success" ]]; then
              echo "### âœ… Destroy (Attempt 2 - Success after retry)" >> $GITHUB_STEP_SUMMARY
            else
              echo "### âŒ Destroy (Attempt 2 - Failed)" >> $GITHUB_STEP_SUMMARY
            fi
            echo "$DESTROY_SUMMARY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>View full destroy attempt 2 output</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat destroy_attempt2_clean.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

  summary:
    needs: [validate-destroy, destroy-apps, destroy-data, destroy-platform, destroy-foundation]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Destroy Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š DESTROY WORKFLOW SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo ""
          
          # Apps status
          if [[ "${{ contains(fromJson(needs.validate-destroy.outputs.layers_to_destroy), 'apps') }}" == "true" ]]; then
            if [[ "${{ needs.destroy-apps.outputs.status }}" == "success" ]]; then
              echo "âœ… Apps: Destroyed successfully"
            elif [[ "${{ needs.destroy-apps.outputs.status }}" == "failed_forced" ]]; then
              echo "âš ï¸ Apps: FAILED but continued due to force flag"
            elif [[ "${{ needs.destroy-apps.result }}" == "skipped" ]]; then
              echo "â­ï¸ Apps: Skipped"
            else
              echo "âŒ Apps: Failed to destroy"
            fi
          fi
          
          # Data status
          if [[ "${{ contains(fromJson(needs.validate-destroy.outputs.layers_to_destroy), 'data') }}" == "true" ]]; then
            if [[ "${{ needs.destroy-data.outputs.status }}" == "success" ]]; then
              echo "âœ… Data: Destroyed successfully"
            elif [[ "${{ needs.destroy-data.outputs.status }}" == "failed_forced" ]]; then
              echo "âš ï¸ Data: FAILED but continued due to force flag"
            elif [[ "${{ needs.destroy-data.result }}" == "skipped" ]]; then
              echo "â­ï¸ Data: Skipped (previous layer failed)"
            else
              echo "âŒ Data: Failed to destroy"
            fi
          fi
          
          # Platform status
          if [[ "${{ contains(fromJson(needs.validate-destroy.outputs.layers_to_destroy), 'platform') }}" == "true" ]]; then
            if [[ "${{ needs.destroy-platform.outputs.status }}" == "success" ]]; then
              echo "âœ… Platform: Destroyed successfully"
            elif [[ "${{ needs.destroy-platform.outputs.status }}" == "failed_forced" ]]; then
              echo "âš ï¸ Platform: FAILED but continued due to force flag"
            elif [[ "${{ needs.destroy-platform.result }}" == "skipped" ]]; then
              echo "â­ï¸ Platform: Skipped (previous layer failed)"
            else
              echo "âŒ Platform: Failed to destroy"
            fi
          fi
          
          # Foundation status
          if [[ "${{ contains(fromJson(needs.validate-destroy.outputs.layers_to_destroy), 'foundation') }}" == "true" ]]; then
            if [[ "${{ needs.destroy-foundation.outputs.status }}" == "success" ]]; then
              echo "âœ… Foundation: Destroyed successfully"
            elif [[ "${{ needs.destroy-foundation.outputs.status }}" == "failed_forced" ]]; then
              echo "âš ï¸ Foundation: FAILED but continued due to force flag"
            elif [[ "${{ needs.destroy-foundation.result }}" == "skipped" ]]; then
              echo "â­ï¸ Foundation: Skipped (previous layer failed)"
            else
              echo "âŒ Foundation: Failed to destroy"
            fi
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Overall status
          if [[ "${{ github.event.inputs.force_continue_on_failure }}" == "true" ]]; then
            echo "âš ï¸ Force-continue was enabled. Check individual layer statuses above."
            echo "âš ï¸ Manual cleanup may be required for failed layers."
          fi
          
          # Check if any layer actually failed
          FAILED=false
          if [[ "${{ needs.destroy-apps.result }}" == "failure" ]] || \
             [[ "${{ needs.destroy-data.result }}" == "failure" ]] || \
             [[ "${{ needs.destroy-platform.result }}" == "failure" ]] || \
             [[ "${{ needs.destroy-foundation.result }}" == "failure" ]]; then
            FAILED=true
          fi
          
          if [[ "$FAILED" == "true" ]] && [[ "${{ github.event.inputs.force_continue_on_failure }}" != "true" ]]; then
            echo ""
            echo "âŒ One or more layers failed to destroy properly"
            echo "ðŸ“– Review the individual job logs above for details"
            exit 1
          fi